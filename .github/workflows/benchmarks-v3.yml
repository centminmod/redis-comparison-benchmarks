name: v3 Benchmark Redis vs KeyDB vs Dragonfly vs Valkey

on:
  workflow_dispatch:
    branches: [master]

permissions:
  contents: write

jobs:
  benchmark:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Cache Docker layers
      uses: actions/cache@v4
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-

    - name: System Info
      run: |
        echo "==== Kernel ===="
        uname -r

        echo "==== CPU Info ===="
        lscpu
    
        echo "==== Memory Info ===="
        free -m
    
        echo "==== Disk Info ===="
        df -hT

    - name: Update System
      run: |
        sudo apt-get update -y
        sudo DEBIAN_FRONTEND=noninteractive apt-get upgrade -y
        sudo DEBIAN_FRONTEND=noninteractive apt-get dist-upgrade -y

    - name: Check IRQ and Network Capabilities
      continue-on-error: true
      run: |
        echo "=== Network Interfaces ==="
        ip link show || ifconfig -a
        
        echo "=== IRQ Information ==="
        cat /proc/interrupts | head -20
        
        echo "=== CPU Topology ==="
        lscpu
        cat /proc/cpuinfo | grep processor
        
        echo "=== Test sudo access ==="
        sudo -n echo "Sudo available" 2>/dev/null || echo "No sudo access to system settings"
        
        echo "=== Test ethtool access ==="
        sudo ethtool -i eth0 2>/dev/null || echo "No ethtool access"

    - name: Generate Distinct CA, Server, and Client Certificates
      run: |
        # Generate CA's private key and self-signed certificate
        openssl genpkey -algorithm RSA -pkeyopt rsa_keygen_bits:2048 -out ca.key
        openssl req -new -x509 -days 365 -key ca.key -out ca.crt -subj "/C=US/ST=Some-State/O=OrganizationName/OU=OrganizationalUnit/CN=CA"
        
        # Generate server's private key and certificate signing request (CSR)
        openssl genpkey -algorithm RSA -pkeyopt rsa_keygen_bits:2048 -out test.key
        openssl req -new -key test.key -out test.csr -subj "/C=US/ST=Some-State/O=OrganizationName/OU=OrganizationalUnit/CN=test.com"
        
        # Sign the server's CSR with the CA's private key to get the server's certificate
        openssl x509 -req -in test.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out test.crt -days 365
        
        # Generate client's private key and CSR
        openssl genpkey -algorithm RSA -pkeyopt rsa_keygen_bits:2048 -out client_priv.pem
        openssl req -new -key client_priv.pem -out client.csr -subj "/C=US/ST=Some-State/O=OrganizationName/OU=OrganizationalUnit/CN=test.server.com"
        
        # Sign the client's CSR with the CA's private key to get the client's certificate
        openssl x509 -req -in client.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out client_cert.pem -days 365

    - name: Update Redis Configuration for non-TLS
      run: |
        echo "io-threads 2" >> redis.conf
        echo "io-threads-do-reads yes" >> redis.conf
        echo "save \"\"" >> redis.conf
        echo "appendonly no" >> redis.conf

    - name: Update KeyDB Configuration for non-TLS
      run: |
        echo "server-threads 2" >> keydb.conf
        echo "io-threads-do-reads yes" >> keydb.conf
        echo "save \"\"" >> keydb.conf
        echo "appendonly no" >> keydb.conf

    - name: Update Dragonfly Configuration for non-TLS
      run: |
        echo "--proactor_threads=4" >> dragonfly-tls.conf
        echo "--dbfilename=''" >> dragonfly-tls.conf

    - name: Update Valkey Configuration for non-TLS
      run: |
        echo "io-threads 2" >> valkey.conf
        echo "io-threads-do-reads yes" >> valkey.conf
        echo "save \"\"" >> valkey.conf
        echo "appendonly no" >> valkey.conf

    - name: Update Redis Configuration for TLS
      run: |
        echo "io-threads 2" >> redis-tls.conf
        echo "io-threads-do-reads yes" >> redis-tls.conf
        echo "tls-port 6390" >> redis-tls.conf
        echo "tls-cert-file /tls/test.crt" >> redis-tls.conf
        echo "tls-key-file /tls/test.key" >> redis-tls.conf
        echo "tls-ca-cert-file /tls/ca.crt" >> redis-tls.conf
        echo "save \"\"" >> redis-tls.conf
        echo "appendonly no" >> redis-tls.conf
    
    - name: Update KeyDB Configuration for TLS
      run: |
        echo "io-threads 2" >> keydb-tls.conf
        echo "io-threads-do-reads yes" >> keydb-tls.conf
        echo "tls-port 6391" >> keydb-tls.conf
        echo "tls-cert-file /tls/test.crt" >> keydb-tls.conf
        echo "tls-key-file /tls/test.key" >> keydb-tls.conf
        echo "tls-ca-cert-file /tls/ca.crt" >> keydb-tls.conf
        echo "save \"\"" >> keydb-tls.conf
        echo "appendonly no" >> keydb-tls.conf
    
    - name: Update Dragonfly Configuration for TLS
      run: |
        echo "--proactor_threads=4" >> dragonfly-tls.conf
        echo "--port=6392" >> dragonfly-tls.conf
        echo "--tls_cert_file=/tls/test.crt" >> dragonfly-tls.conf
        echo "--tls_key_file=/tls/test.key" >> dragonfly-tls.conf
        echo "--tls_ca_cert_file=/tls/ca.crt" >> dragonfly-tls.conf
        echo "--dbfilename=''" >> dragonfly-tls.conf

    - name: Update Valkey Configuration for TLS
      run: |
        echo "io-threads 2" >> valkey-tls.conf
        echo "io-threads-do-reads yes" >> valkey-tls.conf
        echo "tls-port 6393" >> valkey-tls.conf
        echo "tls-cert-file /tls/test.crt" >> valkey-tls.conf
        echo "tls-key-file /tls/test.key" >> valkey-tls.conf
        echo "tls-ca-cert-file /tls/ca.crt" >> valkey-tls.conf
        echo "tls-auth-clients no" >> valkey-tls.conf
        echo "save \"\"" >> valkey-tls.conf
        echo "appendonly no" >> valkey-tls.conf

    - name: Build Redis Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./Dockerfile-redis
        load: true
        tags: redis:latest

    - name: Build KeyDB Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./Dockerfile-keydb
        load: true
        tags: keydb:latest

    - name: Build Dragonfly Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./Dockerfile-dragonfly
        load: true
        tags: dragonfly:latest

    - name: Build Valkey Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./Dockerfile-valkey
        load: true
        tags: valkey:latest

    - name: Build Redis Docker image with TLS
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./Dockerfile-redis-tls
        load: true
        tags: redis-tls:latest
    
    - name: Build KeyDB Docker image with TLS
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./Dockerfile-keydb-tls
        load: true
        tags: keydb-tls:latest
    
    - name: Build Dragonfly Docker image with TLS
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./Dockerfile-dragonfly-tls-nopass
        load: true
        tags: dragonfly-tls:latest

    - name: Build Valkey Docker image with TLS
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./Dockerfile-valkey-tls
        load: true
        tags: valkey-tls:latest

    - name: Run Redis container
      run: |
        docker run -d --name redis -p 6379:6379 --cpuset-cpus="0-3" --ulimit memlock=-1 redis:latest
        sleep 20

    - name: Run KeyDB container
      run: |
        docker run -d --name keydb -p 6380:6379 --cpuset-cpus="0-3" --ulimit memlock=-1 keydb:latest
        sleep 20

    - name: Run Dragonfly container
      run: |
        docker run -d --name dragonfly -p 6381:6379 --cpuset-cpus="0-3" --ulimit memlock=-1 dragonfly:latest
        sleep 20

    - name: Run Redis container with TLS
      run: |
        docker run -d --name redis-tls -p 6390:6390 --cpuset-cpus="0-3" --ulimit memlock=-1 redis-tls:latest
        sleep 20
    
    - name: Run KeyDB container with TLS
      run: |
        docker run -d --name keydb-tls -p 6391:6391 --cpuset-cpus="0-3" --ulimit memlock=-1 keydb-tls:latest
        sleep 20
    
    - name: Run Dragonfly container with TLS
      run: |
        docker run -d --name dragonfly-tls -p 6392:6392 --cpuset-cpus="0-3" --ulimit memlock=-1 dragonfly-tls:latest
        sleep 20

    - name: Run Valkey container
      run: |
        docker run -d --name valkey -p 6382:6379 --cpuset-cpus="0-3" --ulimit memlock=-1 valkey:latest
        sleep 20

    - name: Run Valkey container with TLS
      run: |
        docker run -d --name valkey-tls -p 6393:6393 --cpuset-cpus="0-3" --ulimit memlock=-1 valkey-tls:latest
        sleep 20

    - name: Check Redis logs
      continue-on-error: true
      run: docker logs redis

    # - name: Check Redis config
    #   run: |
    #     docker exec redis ls -lAh /etc/redis/
    
    - name: Test Redis Connectivity
      continue-on-error: true
      run: docker exec redis redis-cli -h 127.0.0.1 -p 6379 PING

    - name: Check KeyDB logs
      continue-on-error: true
      run: docker logs keydb

    # - name: Check KeyDB config
    #   run: |
    #     docker exec keydb ls -lAh /etc/keydb/
    
    - name: Test KeyDB Connectivity
      continue-on-error: true
      run: docker exec keydb keydb-cli -h 127.0.0.1 -p 6379 PING

    - name: Check Dragonfly logs
      continue-on-error: true
      run: docker logs dragonfly

    # - name: Check Dragonfly config
    #   run: |
    #     docker exec dragonfly ls -lAh /etc/dragonfly/
    
    - name: Test Dragonfly Connectivity
      continue-on-error: true
      run: docker exec dragonfly redis-cli -h 127.0.0.1 -p 6379 PING

    - name: Inspect Dragonfly Help
      continue-on-error: true
      run: |
        docker exec dragonfly dragonfly --help || true

    - name: Check Redis TLS logs
      continue-on-error: true
      run: docker logs redis-tls

    # - name: Check Redis TLS config
    #   run: |
    #     docker exec redis-tls ls -lAh /usr/local/etc/redis/

    - name: Check Valkey logs
      continue-on-error: true
      run: docker logs valkey

    - name: Test Valkey Connectivity
      continue-on-error: true
      run: docker exec valkey redis-cli -h 127.0.0.1 -p 6379 PING
    
    - name: Test Redis TLS Connectivity
      continue-on-error: true
      run: docker exec redis-tls redis-cli -h 127.0.0.1 -p 6390 --tls --insecure --cert /tls/test.crt --key /tls/test.key --cacert /tls/ca.crt PING

    - name: Check KeyDB TLS logs
      continue-on-error: true
      run: docker logs keydb-tls

    # - name: Check KeyDB TLS config
    #   run: |
    #     docker exec keydb-tls ls -lAh /etc/keydb/
    
    - name: Test KeyDB TLS Connectivity
      continue-on-error: true
      run: docker exec keydb-tls keydb-cli -h 127.0.0.1 -p 6391 --tls --insecure --cert /tls/test.crt --key /tls/test.key --cacert /tls/ca.crt PING

    - name: Check Dragonfly TLS logs
      continue-on-error: true
      run: docker logs dragonfly-tls

    - name: Check Dragonfly TLS config
      continue-on-error: true
      run: |
        docker exec dragonfly-tls ls -lAh /etc/dragonfly/
   
    - name: Test Dragonfly TLS Connectivity
      continue-on-error: true
      run: |
        docker exec dragonfly-tls redis-cli --help
        docker exec dragonfly-tls redis-cli -h 127.0.0.1 -p 6392 --cert /tls/test.crt --key /tls/test.key --cacert /tls/ca.crt PING

    - name: Check Valkey TLS logs
      continue-on-error: true
      run: docker logs valkey-tls

    - name: Test Valkey TLS Connectivity
      continue-on-error: true
      run: docker exec valkey-tls redis-cli -h 127.0.0.1 -p 6393 --tls --insecure --cert /tls/test.crt --key /tls/test.key --cacert /tls/ca.crt PING

    - name: Check Database Versions
      continue-on-error: true
      run: |
        echo "==== Database Versions ===="
        
        echo "=== Redis Version ==="
        docker exec redis redis-server --version || docker exec redis redis-cli INFO server | grep redis_version | head -1
        
        echo "=== KeyDB Version ==="
        docker exec keydb keydb-server --version || docker exec keydb keydb-cli INFO server | grep -E "(keydb_version|redis_version)" | head -1
        
        echo "=== Dragonfly Version ==="
        docker exec dragonfly dragonfly --version || docker logs dragonfly 2>&1 | grep -i "version\|dragonfly" | head -3
        
        echo "=== Valkey Version ==="
        docker exec valkey valkey-server --version || docker exec valkey redis-cli INFO server | grep -E "(valkey_version|redis_version)" | head -1      

    - name: Check Database Server Configurations
      continue-on-error: true
      run: |
        echo "=================================="
        echo "DATABASE CONFIGURATION ANALYSIS"
        echo "=================================="
        
        echo ""
        echo "=== REDIS CONFIGURATION ==="
        echo "--- IO Threads ---"
        docker exec redis redis-cli CONFIG GET "*io-threads*" || echo "Failed to get Redis IO thread config"
        docker exec redis redis-cli INFO | grep ^io || echo "no ^io"
        echo "--- Memory Settings ---"
        docker exec redis redis-cli CONFIG GET "maxmemory*" || echo "Failed to get Redis memory config"
        echo "--- Save/Persistence ---"
        docker exec redis redis-cli CONFIG GET "save" || echo "Failed to get Redis save config"
        docker exec redis redis-cli CONFIG GET "appendonly" || echo "Failed to get Redis AOF config"
        echo "--- Network ---"
        docker exec redis redis-cli CONFIG GET "*timeout*" || echo "Failed to get Redis timeout config"
        docker exec redis redis-cli CONFIG GET "tcp-*" || echo "Failed to get Redis TCP config"
        echo "--- Performance ---"
        docker exec redis redis-cli CONFIG GET "lazyfree-*" || echo "Failed to get Redis lazyfree config"
        docker exec redis redis-cli INFO stats | grep -E "(keyspace_|expired_|evicted_)" || echo "Failed to get Redis stats"
        
        echo ""
        echo "=== KEYDB CONFIGURATION ==="
        echo "--- IO Threads ---"
        docker exec keydb keydb-cli CONFIG GET "*io-threads*" || echo "Failed to get KeyDB IO thread config"
        docker exec keydb keydb-cli CONFIG GET "*server-threads*" || echo "Failed to get KeyDB IO server thread config"
        docker exec keydb redis-cli INFO | grep ^io || echo "no ^io"
        echo "--- KeyDB Specific ---"
        docker exec keydb keydb-cli CONFIG GET "*multimaster*" || echo "No multimaster config"
        docker exec keydb keydb-cli CONFIG GET "*active-replica*" || echo "No active-replica config"
        echo "--- Memory Settings ---"
        docker exec keydb keydb-cli CONFIG GET "maxmemory*" || echo "Failed to get KeyDB memory config"
        echo "--- Save/Persistence ---"
        docker exec keydb keydb-cli CONFIG GET "save" || echo "Failed to get KeyDB save config"
        docker exec keydb keydb-cli CONFIG GET "appendonly" || echo "Failed to get KeyDB AOF config"
        echo "--- Performance ---"
        docker exec keydb keydb-cli INFO stats | grep -E "(keyspace_|expired_|evicted_)" || echo "Failed to get KeyDB stats"
        
        echo ""
        echo "=== DRAGONFLY CONFIGURATION ==="
        echo "--- Dragonfly Help (Performance Options) ---"
        docker exec dragonfly dragonfly --help | grep -E "(thread|memory|cache|performance)" || echo "Failed to get Dragonfly help"
        echo "--- IO Threads ---"
        docker exec dragonfly redis-cli INFO | grep ^io || echo "no ^io"
        echo "--- Dragonfly Logs (Config Info) ---"
        docker logs dragonfly 2>&1 | grep -E "(thread|memory|port|bind)" | head -10 || echo "No config info in logs"
        echo "--- Dragonfly Process Info ---"
        docker exec dragonfly ps aux | grep dragonfly || echo "Failed to get Dragonfly process info"
        echo "--- Dragonfly Memory Info ---"
        docker exec dragonfly redis-cli INFO memory || echo "Failed to get Dragonfly memory info"
        
        echo ""
        echo "=== VALKEY CONFIGURATION ==="
        echo "--- IO Threads ---"
        docker exec valkey redis-cli CONFIG GET "*io-threads*" || echo "Failed to get Valkey IO thread config"
        docker exec valkey redis-cli INFO | grep ^io || echo "no ^io"
        echo "--- Valkey Specific Features ---"
        docker exec valkey redis-cli CONFIG GET "*async*" || echo "No async config found"
        docker exec valkey redis-cli MODULE LIST || echo "No modules loaded"
        echo "--- Memory Settings ---"
        docker exec valkey redis-cli CONFIG GET "maxmemory*" || echo "Failed to get Valkey memory config"
        echo "--- Save/Persistence ---"
        docker exec valkey redis-cli CONFIG GET "save" || echo "Failed to get Valkey save config"
        docker exec valkey redis-cli CONFIG GET "appendonly" || echo "Failed to get Valkey AOF config"
        echo "--- Network ---"
        docker exec valkey redis-cli CONFIG GET "*timeout*" || echo "Failed to get Valkey timeout config"
        echo "--- Performance ---"
        docker exec valkey redis-cli CONFIG GET "lazyfree-*" || echo "Failed to get Valkey lazyfree config"
        docker exec valkey redis-cli INFO stats | grep -E "(keyspace_|expired_|evicted_)" || echo "Failed to get Valkey stats"
        
        echo ""
        echo "=== CONTAINER RESOURCE ANALYSIS ==="
        echo "--- Container CPU Affinity ---"
        for db in redis keydb dragonfly valkey; do
          if docker ps | grep -q $db; then
            echo "=== $db CPU affinity ==="
            docker exec $db cat /proc/self/status | grep Cpus_allowed_list 2>/dev/null || echo "$db: Could not get CPU affinity"
            docker exec $db cat /proc/self/status | grep "voluntary_ctxt_switches\|nonvoluntary_ctxt_switches" 2>/dev/null || echo "$db: Could not get context switch info"
          fi
        done
        
        echo ""
        echo "--- Container Memory Usage ---"
        docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.MemPerc}}\t{{.NetIO}}\t{{.BlockIO}}" 2>/dev/null || echo "Could not get container stats"
        
        echo ""
        echo "=== BUILD AND VERSION DETAILS ==="
        echo "--- Redis Build Info ---"
        docker exec redis redis-cli INFO server | grep -E "(redis_version|redis_git|redis_build|gcc_version|arch_bits|multiplexing_api|executable)" || echo "Failed to get Redis build info"
        
        echo "--- KeyDB Build Info ---"
        docker exec keydb keydb-cli INFO server | grep -E "(keydb_version|redis_version|gcc_version|arch_bits|multiplexing_api|executable)" || echo "Failed to get KeyDB build info"
        
        echo "--- Dragonfly Build Info ---"
        docker exec dragonfly dragonfly --version 2>/dev/null || docker logs dragonfly 2>&1 | grep -i "version\|build" | head -3 || echo "Failed to get Dragonfly build info"
        
        echo "--- Valkey Build Info ---"
        docker exec valkey redis-cli INFO server | grep -E "(valkey_version|redis_version|gcc_version|arch_bits|multiplexing_api|executable)" || echo "Failed to get Valkey build info"
        
        echo ""
        echo "=== PERFORMANCE-RELATED SYSTEM INFO ==="
        echo "--- Available System Resources ---"
        echo "CPU cores: $(nproc)"
        echo "Memory: $(free -h | grep '^Mem:' | awk '{print $2}')"
        echo "--- Docker Network ---"
        docker network ls
        echo "--- Container Network Mode ---"
        for db in redis keydb dragonfly valkey; do
          if docker ps | grep -q $db; then
            echo "$db network: $(docker inspect $db | grep -i networkmode | head -1)"
          fi
        done
        
        echo ""
        echo "=================================="
        echo "CONFIGURATION ANALYSIS COMPLETE"
        echo "=================================="

    - name: Install memtier_benchmark
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential autoconf automake libpcre3-dev libevent-dev pkg-config zlib1g-dev libssl-dev util-linux
        git clone https://github.com/RedisLabs/memtier_benchmark.git
        cd memtier_benchmark
        autoreconf -ivf
        ./configure
        make
        sudo make install

    - name: Inspect memtier_benchmark Help
      run: |
        memtier_benchmark --help || true

    - name: Create Benchmark Logs Directory
      run: mkdir -p ./benchmarklogs

    - name: Memtier 1 Threads Benchmark Redis
      run: taskset -c 0 memtier_benchmark -s 127.0.0.1 --ratio=1:15 -p 6379 --protocol=redis -t 1 --distinct-client-seed --hide-histogram --requests=5000 --clients=25 --pipeline=1 --data-size=16 --key-pattern=G:G --key-minimum=1 --key-maximum=1000000 --key-median=500000 --key-stddev=166667 | tee ./benchmarklogs/redis_benchmarks_1threads.txt || true

    - name: Memtier 1 Threads Benchmark KeyDB
      run: taskset -c 0 memtier_benchmark -s 127.0.0.1 --ratio=1:15 -p 6380 --protocol=redis -t 1 --distinct-client-seed --hide-histogram --requests=5000 --clients=25 --pipeline=1 --data-size=16 --key-pattern=G:G --key-minimum=1 --key-maximum=1000000 --key-median=500000 --key-stddev=166667 | tee ./benchmarklogs/keydb_benchmarks_1threads.txt || true

    - name: Memtier 1 Threads Benchmark Dragonfly
      run: taskset -c 0 memtier_benchmark -s 127.0.0.1 --ratio=1:15 -p 6381 --protocol=redis -t 1 --distinct-client-seed --hide-histogram --requests=5000 --clients=25 --pipeline=1 --data-size=16 --key-pattern=G:G --key-minimum=1 --key-maximum=1000000 --key-median=500000 --key-stddev=166667 | tee ./benchmarklogs/dragonfly_benchmarks_1threads.txt || true

    - name: Memtier 1 Threads Benchmark Valkey
      run: taskset -c 0 memtier_benchmark -s 127.0.0.1 --ratio=1:15 -p 6382 --protocol=redis -t 1 --distinct-client-seed --hide-histogram --requests=5000 --clients=25 --pipeline=1 --data-size=16 --key-pattern=G:G --key-minimum=1 --key-maximum=1000000 --key-median=500000 --key-stddev=166667 | tee ./benchmarklogs/valkey_benchmarks_1threads.txt || true

    - name: Memtier 2 Threads Benchmark Redis
      run: taskset -c 0,1 memtier_benchmark -s 127.0.0.1 --ratio=1:15 -p 6379 --protocol=redis -t 2 --distinct-client-seed --hide-histogram --requests=5000 --clients=25 --pipeline=1 --data-size=16 --key-pattern=G:G --key-minimum=1 --key-maximum=1000000 --key-median=500000 --key-stddev=166667 | tee ./benchmarklogs/redis_benchmarks_2threads.txt || true

    - name: Memtier 2 Threads Benchmark KeyDB
      run: taskset -c 0,1 memtier_benchmark -s 127.0.0.1 --ratio=1:15 -p 6380 --protocol=redis -t 2 --distinct-client-seed --hide-histogram --requests=5000 --clients=25 --pipeline=1 --data-size=16 --key-pattern=G:G --key-minimum=1 --key-maximum=1000000 --key-median=500000 --key-stddev=166667 | tee ./benchmarklogs/keydb_benchmarks_2threads.txt || true

    - name: Memtier 2 Threads Benchmark Dragonfly
      run: taskset -c 0,1 memtier_benchmark -s 127.0.0.1 --ratio=1:15 -p 6381 --protocol=redis -t 2 --distinct-client-seed --hide-histogram --requests=5000 --clients=25 --pipeline=1 --data-size=16 --key-pattern=G:G --key-minimum=1 --key-maximum=1000000 --key-median=500000 --key-stddev=166667 | tee ./benchmarklogs/dragonfly_benchmarks_2threads.txt || true

    - name: Memtier 2 Threads Benchmark Valkey
      run: taskset -c 0,1 memtier_benchmark -s 127.0.0.1 --ratio=1:15 -p 6382 --protocol=redis -t 2 --distinct-client-seed --hide-histogram --requests=5000 --clients=25 --pipeline=1 --data-size=16 --key-pattern=G:G --key-minimum=1 --key-maximum=1000000 --key-median=500000 --key-stddev=166667 | tee ./benchmarklogs/valkey_benchmarks_2threads.txt || true

    - name: Memtier 4 Threads Benchmark Redis
      run: taskset -c 0,1,2,3 memtier_benchmark -s 127.0.0.1 --ratio=1:15 -p 6379 --protocol=redis -t 4 --distinct-client-seed --hide-histogram --requests=5000 --clients=25 --pipeline=1 --data-size=16 --key-pattern=G:G --key-minimum=1 --key-maximum=1000000 --key-median=500000 --key-stddev=166667 | tee ./benchmarklogs/redis_benchmarks_4threads.txt || true

    - name: Memtier 4 Threads Benchmark KeyDB
      run: taskset -c 0,1,2,3 memtier_benchmark -s 127.0.0.1 --ratio=1:15 -p 6380 --protocol=redis -t 4 --distinct-client-seed --hide-histogram --requests=5000 --clients=25 --pipeline=1 --data-size=16 --key-pattern=G:G --key-minimum=1 --key-maximum=1000000 --key-median=500000 --key-stddev=166667 | tee ./benchmarklogs/keydb_benchmarks_4threads.txt || true

    - name: Memtier 4 Threads Benchmark Dragonfly
      run: taskset -c 0,1,2,3 memtier_benchmark -s 127.0.0.1 --ratio=1:15 -p 6381 --protocol=redis -t 4 --distinct-client-seed --hide-histogram --requests=5000 --clients=25 --pipeline=1 --data-size=16 --key-pattern=G:G --key-minimum=1 --key-maximum=1000000 --key-median=500000 --key-stddev=166667 | tee ./benchmarklogs/dragonfly_benchmarks_4threads.txt || true

    - name: Memtier 4 Threads Benchmark Valkey
      run: taskset -c 0,1,2,3 memtier_benchmark -s 127.0.0.1 --ratio=1:15 -p 6382 --protocol=redis -t 4 --distinct-client-seed --hide-histogram --requests=5000 --clients=25 --pipeline=1 --data-size=16 --key-pattern=G:G --key-minimum=1 --key-maximum=1000000 --key-median=500000 --key-stddev=166667 | tee ./benchmarklogs/valkey_benchmarks_4threads.txt || true

    - name: Memtier 8 Threads Benchmark Redis
      run: memtier_benchmark -s 127.0.0.1 --ratio=1:15 -p 6379 --protocol=redis -t 8 --distinct-client-seed --hide-histogram --requests=5000 --clients=25 --pipeline=1 --data-size=16 --key-pattern=G:G --key-minimum=1 --key-maximum=1000000 --key-median=500000 --key-stddev=166667 | tee ./benchmarklogs/redis_benchmarks_8threads.txt || true

    - name: Memtier 8 Threads Benchmark KeyDB
      run: memtier_benchmark -s 127.0.0.1 --ratio=1:15 -p 6380 --protocol=redis -t 8 --distinct-client-seed --hide-histogram --requests=5000 --clients=25 --pipeline=1 --data-size=16 --key-pattern=G:G --key-minimum=1 --key-maximum=1000000 --key-median=500000 --key-stddev=166667 | tee ./benchmarklogs/keydb_benchmarks_8threads.txt || true

    - name: Memtier 8 Threads Benchmark Dragonfly
      run: memtier_benchmark -s 127.0.0.1 --ratio=1:15 -p 6381 --protocol=redis -t 8 --distinct-client-seed --hide-histogram --requests=5000 --clients=25 --pipeline=1 --data-size=16 --key-pattern=G:G --key-minimum=1 --key-maximum=1000000 --key-median=500000 --key-stddev=166667 | tee ./benchmarklogs/dragonfly_benchmarks_8threads.txt || true

    - name: Memtier 8 Threads Benchmark Valkey
      run: memtier_benchmark -s 127.0.0.1 --ratio=1:15 -p 6382 --protocol=redis -t 8 --distinct-client-seed --hide-histogram --requests=5000 --clients=25 --pipeline=1 --data-size=16 --key-pattern=G:G --key-minimum=1 --key-maximum=1000000 --key-median=500000 --key-stddev=166667 | tee ./benchmarklogs/valkey_benchmarks_8threads.txt || true

    - name: Check Redis IO Thread Usage non-TLS
      run: |
        docker exec redis redis-cli INFO | grep -i thread || echo "threads match"

    - name: Check KeyDB IO Thread Usage non-TLS
      run: |
        docker exec keydb redis-cli INFO | grep -i thread || echo "threads match"

    - name: Check Dragonfly IO Thread Usage non-TLS
      run: |
        docker exec dragonfly redis-cli INFO | grep -i thread || echo "threads match"

    - name: Check Valkey IO Thread Usage non-TLS
      run: |
        docker exec valkey redis-cli INFO | grep -i thread || echo "threads match"

    - name: Memtier 1 Threads Benchmark Redis with TLS
      run: |
        taskset -c 0 memtier_benchmark -s 127.0.0.1 --ratio=1:15 -p 6390 --protocol=redis --tls --cert=${PWD}/test.crt --key=${PWD}/test.key --cacert=${PWD}/ca.crt --tls-skip-verify -t 1 --distinct-client-seed --hide-histogram --requests=5000 --clients=25 --pipeline=1 --data-size=16 --key-pattern=G:G --key-minimum=1 --key-maximum=1000000 --key-median=500000 --key-stddev=166667 | tee ./benchmarklogs/redis_benchmarks_1threads_tls.txt || true
    
    - name: Memtier 1 Threads Benchmark KeyDB with TLS
      run: |
        taskset -c 0 memtier_benchmark -s 127.0.0.1 --ratio=1:15 -p 6391 --protocol=redis --tls --cert=${PWD}/test.crt --key=${PWD}/test.key --cacert=${PWD}/ca.crt --tls-skip-verify -t 1 --distinct-client-seed --hide-histogram --requests=5000 --clients=25 --pipeline=1 --data-size=16 --key-pattern=G:G --key-minimum=1 --key-maximum=1000000 --key-median=500000 --key-stddev=166667 | tee ./benchmarklogs/keydb_benchmarks_1threads_tls.txt || true
    
    - name: Memtier 1 Threads Benchmark Dragonfly with TLS
      run: |
        taskset -c 0 memtier_benchmark -s 127.0.0.1 --ratio=1:15 -p 6392 --protocol=redis --tls --cert=${PWD}/client_cert.pem --key=${PWD}/client_priv.pem --cacert=${PWD}/ca.crt -t 1 --distinct-client-seed --hide-histogram --requests=5000 --clients=25 --pipeline=1 --data-size=16 --key-pattern=G:G --key-minimum=1 --key-maximum=1000000 --key-median=500000 --key-stddev=166667 | tee ./benchmarklogs/dragonfly_benchmarks_1threads_tls.txt || true
    
    - name: Memtier 1 Threads Benchmark Valkey with TLS
      run: |
        taskset -c 0 memtier_benchmark -s 127.0.0.1 --ratio=1:15 -p 6393 --protocol=redis --tls --cert=${PWD}/test.crt --key=${PWD}/test.key --cacert=${PWD}/ca.crt --tls-skip-verify -t 1 --distinct-client-seed --hide-histogram --requests=5000 --clients=25 --pipeline=1 --data-size=16 --key-pattern=G:G --key-minimum=1 --key-maximum=1000000 --key-median=500000 --key-stddev=166667 | tee ./benchmarklogs/valkey_benchmarks_1threads_tls.txt || true

    - name: Memtier 2 Threads Benchmark Redis with TLS
      run: |
        taskset -c 0,1 memtier_benchmark -s 127.0.0.1 --ratio=1:15 -p 6390 --protocol=redis --tls --cert=${PWD}/test.crt --key=${PWD}/test.key --cacert=${PWD}/ca.crt --tls-skip-verify -t 2 --distinct-client-seed --hide-histogram --requests=5000 --clients=25 --pipeline=1 --data-size=16 --key-pattern=G:G --key-minimum=1 --key-maximum=1000000 --key-median=500000 --key-stddev=166667 | tee ./benchmarklogs/redis_benchmarks_2threads_tls.txt || true
    
    - name: Memtier 2 Threads Benchmark KeyDB with TLS
      run: |
        taskset -c 0,1 memtier_benchmark -s 127.0.0.1 --ratio=1:15 -p 6391 --protocol=redis --tls --cert=${PWD}/test.crt --key=${PWD}/test.key --cacert=${PWD}/ca.crt --tls-skip-verify -t 2 --distinct-client-seed --hide-histogram --requests=5000 --clients=25 --pipeline=1 --data-size=16 --key-pattern=G:G --key-minimum=1 --key-maximum=1000000 --key-median=500000 --key-stddev=166667 | tee ./benchmarklogs/keydb_benchmarks_2threads_tls.txt || true
    
    - name: Memtier 2 Threads Benchmark Dragonfly with TLS
      run: |
        taskset -c 0,1 memtier_benchmark -s 127.0.0.1 --ratio=1:15 -p 6392 --protocol=redis --tls --cert=${PWD}/client_cert.pem --key=${PWD}/client_priv.pem --cacert=${PWD}/ca.crt -t 2 --distinct-client-seed --hide-histogram --requests=5000 --clients=25 --pipeline=1 --data-size=16 --key-pattern=G:G --key-minimum=1 --key-maximum=1000000 --key-median=500000 --key-stddev=166667 | tee ./benchmarklogs/dragonfly_benchmarks_2threads_tls.txt || true
    
    - name: Memtier 2 Threads Benchmark Valkey with TLS
      run: |
        taskset -c 0,1 memtier_benchmark -s 127.0.0.1 --ratio=1:15 -p 6393 --protocol=redis --tls --cert=${PWD}/test.crt --key=${PWD}/test.key --cacert=${PWD}/ca.crt --tls-skip-verify -t 2 --distinct-client-seed --hide-histogram --requests=5000 --clients=25 --pipeline=1 --data-size=16 --key-pattern=G:G --key-minimum=1 --key-maximum=1000000 --key-median=500000 --key-stddev=166667 | tee ./benchmarklogs/valkey_benchmarks_2threads_tls.txt || true

    - name: Memtier 4 Threads Benchmark Redis with TLS
      run: |
        taskset -c 0,1,2,3 memtier_benchmark -s 127.0.0.1 --ratio=1:15 -p 6390 --protocol=redis --tls --cert=${PWD}/test.crt --key=${PWD}/test.key --cacert=${PWD}/ca.crt --tls-skip-verify -t 4 --distinct-client-seed --hide-histogram --requests=5000 --clients=25 --pipeline=1 --data-size=16 --key-pattern=G:G --key-minimum=1 --key-maximum=1000000 --key-median=500000 --key-stddev=166667 | tee ./benchmarklogs/redis_benchmarks_4threads_tls.txt || true
    
    - name: Memtier 4 Threads Benchmark KeyDB with TLS
      run: |
        taskset -c 0,1,2,3 memtier_benchmark -s 127.0.0.1 --ratio=1:15 -p 6391 --protocol=redis --tls --cert=${PWD}/test.crt --key=${PWD}/test.key --cacert=${PWD}/ca.crt --tls-skip-verify -t 4 --distinct-client-seed --hide-histogram --requests=5000 --clients=25 --pipeline=1 --data-size=16 --key-pattern=G:G --key-minimum=1 --key-maximum=1000000 --key-median=500000 --key-stddev=166667 | tee ./benchmarklogs/keydb_benchmarks_4threads_tls.txt || true
    
    - name: Memtier 4 Threads Benchmark Dragonfly with TLS
      run: |
        taskset -c 0,1,2,3 memtier_benchmark -s 127.0.0.1 --ratio=1:15 -p 6392 --protocol=redis --tls --cert=${PWD}/client_cert.pem --key=${PWD}/client_priv.pem --cacert=${PWD}/ca.crt -t 4 --distinct-client-seed --hide-histogram --requests=5000 --clients=25 --pipeline=1 --data-size=16 --key-pattern=G:G --key-minimum=1 --key-maximum=1000000 --key-median=500000 --key-stddev=166667 | tee ./benchmarklogs/dragonfly_benchmarks_4threads_tls.txt || true
    
    - name: Memtier 4 Threads Benchmark Valkey with TLS
      run: |
        taskset -c 0,1,2,3 memtier_benchmark -s 127.0.0.1 --ratio=1:15 -p 6393 --protocol=redis --tls --cert=${PWD}/test.crt --key=${PWD}/test.key --cacert=${PWD}/ca.crt --tls-skip-verify -t 4 --distinct-client-seed --hide-histogram --requests=5000 --clients=25 --pipeline=1 --data-size=16 --key-pattern=G:G --key-minimum=1 --key-maximum=1000000 --key-median=500000 --key-stddev=166667 | tee ./benchmarklogs/valkey_benchmarks_4threads_tls.txt || true

    - name: Memtier 8 Threads Benchmark Redis with TLS
      run: |
        memtier_benchmark -s 127.0.0.1 --ratio=1:15 -p 6390 --protocol=redis --tls --cert=${PWD}/test.crt --key=${PWD}/test.key --cacert=${PWD}/ca.crt --tls-skip-verify -t 8 --distinct-client-seed --hide-histogram --requests=5000 --clients=25 --pipeline=1 --data-size=16 --key-pattern=G:G --key-minimum=1 --key-maximum=1000000 --key-median=500000 --key-stddev=166667 | tee ./benchmarklogs/redis_benchmarks_8threads_tls.txt || true
    
    - name: Memtier 8 Threads Benchmark KeyDB with TLS
      run: |
        memtier_benchmark -s 127.0.0.1 --ratio=1:15 -p 6391 --protocol=redis --tls --cert=${PWD}/test.crt --key=${PWD}/test.key --cacert=${PWD}/ca.crt --tls-skip-verify -t 8 --distinct-client-seed --hide-histogram --requests=5000 --clients=25 --pipeline=1 --data-size=16 --key-pattern=G:G --key-minimum=1 --key-maximum=1000000 --key-median=500000 --key-stddev=166667 | tee ./benchmarklogs/keydb_benchmarks_8threads_tls.txt || true
    
    - name: Memtier 8 Threads Benchmark Dragonfly with TLS
      run: |
        memtier_benchmark -s 127.0.0.1 --ratio=1:15 -p 6392 --protocol=redis --tls --cert=${PWD}/client_cert.pem --key=${PWD}/client_priv.pem --cacert=${PWD}/ca.crt -t 8 --distinct-client-seed --hide-histogram --requests=5000 --clients=25 --pipeline=1 --data-size=16 --key-pattern=G:G --key-minimum=1 --key-maximum=1000000 --key-median=500000 --key-stddev=166667 | tee ./benchmarklogs/dragonfly_benchmarks_8threads_tls.txt || true

    - name: Memtier 8 Threads Benchmark Valkey with TLS
      run: |
        memtier_benchmark -s 127.0.0.1 --ratio=1:15 -p 6393 --protocol=redis --tls --cert=${PWD}/test.crt --key=${PWD}/test.key --cacert=${PWD}/ca.crt --tls-skip-verify -t 8 --distinct-client-seed --hide-histogram --requests=5000 --clients=25 --pipeline=1 --data-size=16 --key-pattern=G:G --key-minimum=1 --key-maximum=1000000 --key-median=500000 --key-stddev=166667 | tee ./benchmarklogs/valkey_benchmarks_8threads_tls.txt || true

    - name: Convert Redis 1 Threads Benchmark to MD
      continue-on-error: true
      run: |
        python scripts/parse_memtier_to_md.py ./benchmarklogs/redis_benchmarks_1threads.txt "Redis 1 Thread"
        cat ./benchmarklogs/redis_benchmarks_1threads.md

    - name: Convert KeyDB 1 Threads Benchmark to MD
      continue-on-error: true
      run: |
        python scripts/parse_memtier_to_md.py ./benchmarklogs/keydb_benchmarks_1threads.txt "KeyDB 1 Thread"
        cat ./benchmarklogs/keydb_benchmarks_1threads.md

    - name: Convert Dragonfly 1 Threads Benchmark to MD
      continue-on-error: true
      run: |
        python scripts/parse_memtier_to_md.py ./benchmarklogs/dragonfly_benchmarks_1threads.txt "Dragonfly 1 Threads"
        cat ./benchmarklogs/dragonfly_benchmarks_1threads.md

    - name: Convert Valkey 1 Threads Benchmark to MD
      continue-on-error: true
      run: |
        python scripts/parse_memtier_to_md.py ./benchmarklogs/valkey_benchmarks_1threads.txt "Valkey 1 Thread"
        cat ./benchmarklogs/valkey_benchmarks_1threads.md

    - name: Convert Redis 2 Threads Benchmark to MD
      continue-on-error: true
      run: |
        python scripts/parse_memtier_to_md.py ./benchmarklogs/redis_benchmarks_2threads.txt "Redis 2 Threads"
        cat ./benchmarklogs/redis_benchmarks_2threads.md

    - name: Convert KeyDB 2 Threads Benchmark to MD
      continue-on-error: true
      run: |
        python scripts/parse_memtier_to_md.py ./benchmarklogs/keydb_benchmarks_2threads.txt "KeyDB 2 Threads"
        cat ./benchmarklogs/keydb_benchmarks_2threads.md

    - name: Convert Dragonfly 2 Threads Benchmark to MD
      continue-on-error: true
      run: |
        python scripts/parse_memtier_to_md.py ./benchmarklogs/dragonfly_benchmarks_2threads.txt "Dragonfly 2 Thread"
        cat ./benchmarklogs/dragonfly_benchmarks_2threads.md

    - name: Convert Valkey 2 Threads Benchmark to MD
      continue-on-error: true
      run: |
        python scripts/parse_memtier_to_md.py ./benchmarklogs/valkey_benchmarks_2threads.txt "Valkey 2 Threads"
        cat ./benchmarklogs/valkey_benchmarks_2threads.md

    - name: Convert Redis 4 Threads Benchmark to MD
      continue-on-error: true
      run: |
        python scripts/parse_memtier_to_md.py ./benchmarklogs/redis_benchmarks_4threads.txt "Redis 4 Threads"
        cat ./benchmarklogs/redis_benchmarks_4threads.md

    - name: Convert KeyDB 4 Threads Benchmark to MD
      continue-on-error: true
      run: |
        python scripts/parse_memtier_to_md.py ./benchmarklogs/keydb_benchmarks_4threads.txt "KeyDB 4 Threads"
        cat ./benchmarklogs/keydb_benchmarks_4threads.md

    - name: Convert Dragonfly 4 Threads Benchmark to MD
      continue-on-error: true
      run: |
        python scripts/parse_memtier_to_md.py ./benchmarklogs/dragonfly_benchmarks_4threads.txt "Dragonfly 4 Threads"
        cat ./benchmarklogs/dragonfly_benchmarks_4threads.md

    - name: Convert Valkey 4 Threads Benchmark to MD
      continue-on-error: true
      run: |
        python scripts/parse_memtier_to_md.py ./benchmarklogs/valkey_benchmarks_4threads.txt "Valkey 4 Threads"
        cat ./benchmarklogs/valkey_benchmarks_4threads.md

    - name: Convert Redis 8 Threads Benchmark to MD
      continue-on-error: true
      run: |
        python scripts/parse_memtier_to_md.py ./benchmarklogs/redis_benchmarks_8threads.txt "Redis 8 Threads"
        cat ./benchmarklogs/redis_benchmarks_8threads.md

    - name: Convert KeyDB 8 Threads Benchmark to MD
      continue-on-error: true
      run: |
        python scripts/parse_memtier_to_md.py ./benchmarklogs/keydb_benchmarks_8threads.txt "KeyDB 8 Threads"
        cat ./benchmarklogs/keydb_benchmarks_8threads.md

    - name: Convert Dragonfly 8 Threads Benchmark to MD
      continue-on-error: true
      run: |
        python scripts/parse_memtier_to_md.py ./benchmarklogs/dragonfly_benchmarks_8threads.txt "Dragonfly 8 Threads"
        cat ./benchmarklogs/dragonfly_benchmarks_8threads.md

    - name: Convert Valkey 8 Threads Benchmark to MD
      continue-on-error: true
      run: |
        python scripts/parse_memtier_to_md.py ./benchmarklogs/valkey_benchmarks_8threads.txt "Valkey 8 Threads"
        cat ./benchmarklogs/valkey_benchmarks_8threads.md

    - name: Convert Redis 1 Threads Benchmark with TLS to MD
      continue-on-error: true
      run: |
        python scripts/parse_memtier_to_md.py ./benchmarklogs/redis_benchmarks_1threads_tls.txt "Redis TLS 1 Thread"
        cat ./benchmarklogs/redis_benchmarks_1threads_tls.md
    
    - name: Convert KeyDB 1 Threads Benchmark with TLS to MD
      continue-on-error: true
      run: |
        python scripts/parse_memtier_to_md.py ./benchmarklogs/keydb_benchmarks_1threads_tls.txt "KeyDB TLS 1 Thread"
        cat ./benchmarklogs/keydb_benchmarks_1threads_tls.md
    
    - name: Convert Dragonfly 1 Threads Benchmark with TLS to MD
      continue-on-error: true
      run: |
        python scripts/parse_memtier_to_md.py ./benchmarklogs/dragonfly_benchmarks_1threads_tls.txt "Dragonfly TLS 1 Thread"
        cat ./benchmarklogs/dragonfly_benchmarks_1threads_tls.md

    - name: Convert Valkey 1 Threads Benchmark with TLS to MD
      continue-on-error: true
      run: |
        python scripts/parse_memtier_to_md.py ./benchmarklogs/valkey_benchmarks_1threads_tls.txt "Valkey TLS 1 Thread"
        cat ./benchmarklogs/valkey_benchmarks_1threads_tls.md
    
    - name: Convert Redis 2 Threads Benchmark with TLS to MD
      continue-on-error: true
      run: |
        python scripts/parse_memtier_to_md.py ./benchmarklogs/redis_benchmarks_2threads_tls.txt "Redis TLS 2 Threads"
        cat ./benchmarklogs/redis_benchmarks_2threads_tls.md
    
    - name: Convert KeyDB 2 Threads Benchmark with TLS to MD
      continue-on-error: true
      run: |
        python scripts/parse_memtier_to_md.py ./benchmarklogs/keydb_benchmarks_2threads_tls.txt "KeyDB TLS 2 Threads"
        cat ./benchmarklogs/keydb_benchmarks_2threads_tls.md
    
    - name: Convert Dragonfly 2 Threads Benchmark with TLS to MD
      continue-on-error: true
      run: |
        python scripts/parse_memtier_to_md.py ./benchmarklogs/dragonfly_benchmarks_2threads_tls.txt "Dragonfly TLS 2 Threads"
        cat ./benchmarklogs/dragonfly_benchmarks_2threads_tls.md

    - name: Convert Valkey 2 Threads Benchmark with TLS to MD
      continue-on-error: true
      run: |
        python scripts/parse_memtier_to_md.py ./benchmarklogs/valkey_benchmarks_2threads_tls.txt "Valkey TLS 2 Threads"
        cat ./benchmarklogs/valkey_benchmarks_2threads_tls.md

    - name: Convert Redis 4 Threads Benchmark with TLS to MD
      continue-on-error: true
      run: |
        python scripts/parse_memtier_to_md.py ./benchmarklogs/redis_benchmarks_4threads_tls.txt "Redis TLS 4 Threads"
        cat ./benchmarklogs/redis_benchmarks_4threads_tls.md
    
    - name: Convert KeyDB 4 Threads Benchmark with TLS to MD
      continue-on-error: true
      run: |
        python scripts/parse_memtier_to_md.py ./benchmarklogs/keydb_benchmarks_4threads_tls.txt "KeyDB TLS 4 Threads"
        cat ./benchmarklogs/keydb_benchmarks_4threads_tls.md
    
    - name: Convert Dragonfly 4 Threads Benchmark with TLS to MD
      continue-on-error: true
      run: |
        python scripts/parse_memtier_to_md.py ./benchmarklogs/dragonfly_benchmarks_4threads_tls.txt "Dragonfly TLS 4 Threads"
        cat ./benchmarklogs/dragonfly_benchmarks_4threads_tls.md

    - name: Convert Valkey 4 Threads Benchmark with TLS to MD
      continue-on-error: true
      run: |
        python scripts/parse_memtier_to_md.py ./benchmarklogs/valkey_benchmarks_4threads_tls.txt "Valkey TLS 4 Threads"
        cat ./benchmarklogs/valkey_benchmarks_4threads_tls.md
    
    - name: Convert Redis 8 Threads Benchmark with TLS to MD
      continue-on-error: true
      run: |
        python scripts/parse_memtier_to_md.py ./benchmarklogs/redis_benchmarks_8threads_tls.txt "Redis TLS 8 Threads"
        cat ./benchmarklogs/redis_benchmarks_8threads_tls.md
    
    - name: Convert KeyDB 8 Threads Benchmark with TLS to MD
      continue-on-error: true
      run: |
        python scripts/parse_memtier_to_md.py ./benchmarklogs/keydb_benchmarks_8threads_tls.txt "KeyDB TLS 8 Threads"
        cat ./benchmarklogs/keydb_benchmarks_8threads_tls.md
    
    - name: Convert Dragonfly 8 Threads Benchmark with TLS to MD
      continue-on-error: true
      run: |
        python scripts/parse_memtier_to_md.py ./benchmarklogs/dragonfly_benchmarks_8threads_tls.txt "Dragonfly TLS 8 Threads"
        cat ./benchmarklogs/dragonfly_benchmarks_8threads_tls.md

    - name: Convert Valkey 8 Threads Benchmark with TLS to MD
      continue-on-error: true
      run: |
        python scripts/parse_memtier_to_md.py ./benchmarklogs/valkey_benchmarks_8threads_tls.txt "Valkey TLS 8 Threads"
        cat ./benchmarklogs/valkey_benchmarks_8threads_tls.md

    - name: Combine Redis Benchmark MD Table
      continue-on-error: true
      run: |
        python scripts/combine_markdown_results.py "./benchmarklogs/redis_benchmarks_1threads.md ./benchmarklogs/redis_benchmarks_2threads.md ./benchmarklogs/redis_benchmarks_4threads.md ./benchmarklogs/redis_benchmarks_8threads.md" redis
        cat ./benchmarklogs/combined_redis_results.md

    - name: Combine KeyDB Benchmark MD Table
      continue-on-error: true
      run: |
        python scripts/combine_markdown_results.py "./benchmarklogs/keydb_benchmarks_1threads.md ./benchmarklogs/keydb_benchmarks_2threads.md ./benchmarklogs/keydb_benchmarks_4threads.md ./benchmarklogs/keydb_benchmarks_8threads.md" keydb
        cat ./benchmarklogs/combined_keydb_results.md

    - name: Combine Dragonfly Benchmark MD Table
      continue-on-error: true
      run: |
        python scripts/combine_markdown_results.py "./benchmarklogs/dragonfly_benchmarks_1threads.md ./benchmarklogs/dragonfly_benchmarks_2threads.md ./benchmarklogs/dragonfly_benchmarks_4threads.md ./benchmarklogs/dragonfly_benchmarks_8threads.md" dragonfly
        cat ./benchmarklogs/combined_dragonfly_results.md

    - name: Combine Valkey Benchmark MD Table
      continue-on-error: true
      run: |
        python scripts/combine_markdown_results.py "./benchmarklogs/valkey_benchmarks_1threads.md ./benchmarklogs/valkey_benchmarks_2threads.md ./benchmarklogs/valkey_benchmarks_4threads.md ./benchmarklogs/valkey_benchmarks_8threads.md" valkey
        cat ./benchmarklogs/combined_valkey_results.md

    - name: Combine Redis TLS Benchmark MD Table
      continue-on-error: true
      run: |
        python scripts/combine_markdown_results.py "./benchmarklogs/redis_benchmarks_1threads_tls.md ./benchmarklogs/redis_benchmarks_2threads_tls.md ./benchmarklogs/redis_benchmarks_4threads_tls.md ./benchmarklogs/redis_benchmarks_8threads_tls.md" "redis-tls"
        cat ./benchmarklogs/combined_redis-tls_results.md

    - name: Combine KeyDB TLS Benchmark MD Table
      continue-on-error: true
      run: |
        python scripts/combine_markdown_results.py "./benchmarklogs/keydb_benchmarks_1threads_tls.md ./benchmarklogs/keydb_benchmarks_2threads_tls.md ./benchmarklogs/keydb_benchmarks_4threads_tls.md ./benchmarklogs/keydb_benchmarks_8threads_tls.md" "keydb-tls"
        cat ./benchmarklogs/combined_keydb-tls_results.md

    - name: Combine Dragonfly TLS Benchmark MD Table
      continue-on-error: true
      run: |
        python scripts/combine_markdown_results.py "./benchmarklogs/dragonfly_benchmarks_1threads_tls.md ./benchmarklogs/dragonfly_benchmarks_2threads_tls.md ./benchmarklogs/dragonfly_benchmarks_4threads_tls.md ./benchmarklogs/dragonfly_benchmarks_8threads_tls.md" "dragonfly-tls"
        cat ./benchmarklogs/combined_dragonfly-tls_results.md

    - name: Combine Valkey TLS Benchmark MD Table
      continue-on-error: true
      run: |
        python scripts/combine_markdown_results.py "./benchmarklogs/valkey_benchmarks_1threads_tls.md ./benchmarklogs/valkey_benchmarks_2threads_tls.md ./benchmarklogs/valkey_benchmarks_4threads_tls.md ./benchmarklogs/valkey_benchmarks_8threads_tls.md" "valkey-tls"
        cat ./benchmarklogs/combined_valkey-tls_results.md

    - name: Combine benchmark Markdown results
      continue-on-error: true
      run: |
        # Create a single combined file in the desired order
        cat \
          ./benchmarklogs/combined_redis_results.md \
          ./benchmarklogs/combined_keydb_results.md \
          ./benchmarklogs/combined_dragonfly_results.md \
          ./benchmarklogs/combined_valkey_results.md \
          > ./combined_all_results.md

        echo "✅ All results merged into combined_all_results.md"

    - name: Combine TLS benchmark Markdown results
      continue-on-error: true
      run: |
        # Create a single combined file in the desired order
        cat \
          ./benchmarklogs/combined_redis-tls_results.md \
          ./benchmarklogs/combined_keydb-tls_results.md \
          ./benchmarklogs/combined_dragonfly-tls_results.md \
          ./benchmarklogs/combined_valkey-tls_results.md \
          > ./combined_all_results_tls.md

        echo "✅ All results merged into combined_all_results_tls.md"

    - name: Debug Combined Results File
      run: |
        echo "=== Check if combined file exists ==="
        ls -la combined_all_results.md
        echo "=== First 20 lines of combined file ==="
        head -20 combined_all_results.md
        echo "=== File size ==="
        wc -l combined_all_results.md

    - name: Set up Python 3.x
      uses: actions/setup-python@v5
      with:
        python-version: "3.x"

    - name: Install charting dependencies
      run: |
        python -m pip install --upgrade pip
        pip install matplotlib numpy

    - name: Debug Chart Input Data
      continue-on-error: true
      run: |
        echo "=== Contents of combined_all_results.md ==="
        cat combined_all_results.md
        
        echo "=== Check for database names ==="
        grep -E "(Redis|KeyDB|Dragonfly|Valkey)" combined_all_results.md || echo "No database names found"
        
        echo "=== Check for Ops/sec data ==="
        grep -i "ops/sec" combined_all_results.md || echo "No ops/sec data found"
        
        echo "=== Check table structure ==="
        grep "|" combined_all_results.md | head -10

    - name: Generate non-TLS Latency Charts
      continue-on-error: true
      run: |
        python scripts/latency-charts.py combined_all_results.md nonTLS 2>&1 | tee ./benchmarklogs/latency-charts-nonTLS.log

    - name: Generate non-TLS Ops/Sec Charts
      continue-on-error: true
      run: |
        python scripts/opssec-charts.py combined_all_results.md nonTLS 2>&1 | tee ./benchmarklogs/opssec-charts-nonTLS.log

    - name: Generate TLS Latency Charts
      continue-on-error: true
      run: |
        python scripts/latency-charts.py combined_all_results_tls.md TLS 2>&1 | tee ./benchmarklogs/latency-charts-TLS.log

    - name: Generate TLS Ops/Sec Charts
      continue-on-error: true
      run: |
        python scripts/opssec-charts.py combined_all_results_tls.md TLS 2>&1 | tee ./benchmarklogs/opssec-charts-TLS.log

    - name: Capture Versions for Benchmark Report
      continue-on-error: true
      run: |
        mkdir -p ./benchmarklogs
        echo "# Database Versions Used" > ./benchmarklogs/versions.md
        echo "" >> ./benchmarklogs/versions.md
        echo "| Database | Version |" >> ./benchmarklogs/versions.md
        echo "|----------|---------|" >> ./benchmarklogs/versions.md
        
        REDIS_VER=$(docker exec redis redis-server --version 2>/dev/null | cut -d' ' -f3 || docker exec redis redis-cli INFO server | grep redis_version | cut -d: -f2 | tr -d '\r')
        echo "| Redis | ${REDIS_VER} |" >> ./benchmarklogs/versions.md
        
        KEYDB_VER=$(docker exec keydb keydb-server --version 2>/dev/null | cut -d' ' -f3 || docker exec keydb keydb-cli INFO server | grep -E "(keydb_version|redis_version)" | head -1 | cut -d: -f2 | tr -d '\r')
        echo "| KeyDB | ${KEYDB_VER} |" >> ./benchmarklogs/versions.md
        
        DRAGONFLY_VER=$(docker exec dragonfly dragonfly --version 2>/dev/null | cut -d' ' -f2 || docker logs dragonfly 2>&1 | grep -i "version" | head -1 | cut -d' ' -f4 || echo "unknown")
        echo "| Dragonfly | ${DRAGONFLY_VER} |" >> ./benchmarklogs/versions.md
        
        VALKEY_VER=$(docker exec valkey valkey-server --version 2>/dev/null | cut -d' ' -f3 || docker exec valkey redis-cli INFO server | grep -E "(valkey_version|redis_version)" | head -1 | cut -d: -f2 | tr -d '\r')
        echo "| Valkey | ${VALKEY_VER} |" >> ./benchmarklogs/versions.md
        
        cat ./benchmarklogs/versions.md

    - name: Commit Benchmark Results to Repository
      continue-on-error: true
      run: |
        # Configure git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # Fetch latest changes
        git fetch origin
        
        # Create results directory structure
        mkdir -p results/benchmarks-v3
        
        # Copy files to results directory
        cp ./benchmarklogs/versions.md results/benchmarks-v3/
        sed '/| ---------------------------------------------------------------------------------------------------------------------------- |/d' combined_all_results.md
        sed '/| ---------------------------------------------------------------------------------------------------------------------------- |/d' combined_all_results_tls.md
        cp combined_all_results.md results/benchmarks-v3/
        cp combined_all_results_tls.md results/benchmarks-v3/
        
        # Copy chart files (only if they exist)
        [ -f latency-nonTLS-avg.png ] && cp latency-nonTLS-avg.png results/benchmarks-v3/
        [ -f latency-nonTLS-p50.png ] && cp latency-nonTLS-p50.png results/benchmarks-v3/
        [ -f latency-nonTLS-p99.png ] && cp latency-nonTLS-p99.png results/benchmarks-v3/
        [ -f latency-TLS-avg.png ] && cp latency-TLS-avg.png results/benchmarks-v3/
        [ -f latency-TLS-p50.png ] && cp latency-TLS-p50.png results/benchmarks-v3/
        [ -f latency-TLS-p99.png ] && cp latency-TLS-p99.png results/benchmarks-v3/
        [ -f ops-nonTLS.png ] && cp ops-nonTLS.png results/benchmarks-v3/
        [ -f ops-TLS.png ] && cp ops-TLS.png results/benchmarks-v3/
        
        # Add a timestamp file
        echo "Last updated: $(date -u)" > results/benchmarks-v3/last_updated.txt
        echo "Workflow run: ${{ github.run_number }}" >> results/benchmarks-v3/last_updated.txt
        echo "Commit SHA: ${{ github.sha }}" >> results/benchmarks-v3/last_updated.txt
        
        # Stage all changes
        git add results/benchmarks-v3/
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          # Commit changes
          git commit -m "Update benchmark results from workflow run #${{ github.run_number }}
          
          - Updated benchmark results for Redis, KeyDB, Dragonfly, and Valkey
          - Generated charts for latency and ops/sec metrics
          - Both TLS and non-TLS configurations tested
          - Workflow: ${{ github.workflow }}
          - Run: ${{ github.run_number }}
          - SHA: ${{ github.sha }}"
          
          # Try to push, if it fails due to new commits, pull and retry
          if ! git push origin HEAD; then
            echo "Push failed, pulling latest changes and retrying..."
            
            # Pull with rebase to keep our commit on top
            git pull --rebase origin ${{ github.ref_name }}
            
            # Try push again
            git push origin HEAD
          fi
          
          echo "✅ Benchmark results committed and pushed to results/benchmarks-v3/"
        fi

    - name: Upload Benchmark Logs and Charts
      uses: actions/upload-artifact@v4
      with:
        name: all_benchmark_artifacts
        path: |
          benchmarklogs/**
          combined_all_results.md
          combined_all_results_tls.md
          latency-nonTLS-avg.png
          latency-nonTLS-p50.png
          latency-nonTLS-p99.png
          ops-nonTLS.png
          latency-TLS-avg.png
          latency-TLS-p50.png
          latency-TLS-p99.png
          ops-TLS.png

    - name: Cleanup
      run: |
        docker stop redis
        docker stop keydb
        docker stop dragonfly
        docker stop valkey
        docker stop redis-tls
        docker stop keydb-tls
        docker stop dragonfly-tls
        docker stop valkey-tls